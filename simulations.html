<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAT Simulation Dashboard</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #000;
      margin: 0;
      padding: 0;
      color: white;
    }

    /* ===== HEADER ===== */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      border-bottom: 1px solid white;
      background-color: #000;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    header h1 {
      font-size: 22px;
      margin: 0;
      color: #ffffff;
    }

    nav a {
      display: inline-block;
      color: #ffffff;
      text-decoration: none;
      margin-left: 18px;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    nav a:hover {
      color: #bbbbbb;
    }

    /* ===== MAIN CONTENT ===== */
    main {
      padding: 40px;
    }

    h2 {
      text-align: center;
      margin-bottom: 40px;
      font-size: 26px;
    }

    .top-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 40px;
    }

    input[type="text"] {
      padding: 12px 16px;
      border: 1px solid #555;
      border-radius: 8px;
      background-color: #111;
      color: #fff;
      width: 260px;
      font-size: 15px;
      outline: none;
      transition: border 0.3s;
    }

    input[type="text"]:focus {
      border-color: #888;
    }

    .btn-create {
      padding: 12px 24px;
      background-color: transparent;
      color: #fff;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      background-color: rgba(255, 255, 255, 0.05);
    }

    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .renameSection
    {
      background-color: #000000dc;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0px;
      left: 0px;
      display: none;
      flex-direction: column;
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .renameSection >* {
      margin: 10px;
    }

    .renameSection button {
      padding: 12px 24px;
      background-color: transparent;
      color: #fff;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
    }

    .card {
      background-color: #111;
      width: 260px;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(255,255,255,0.05);
      transition: 0.3s;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(255,255,255,0.08);
      cursor: pointer;
    }

    #contextMenu {
      display: none;
      position: absolute;
      background: #111;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 5px 0;
      width: 180px;
      z-index: 1000;
    }

    #contextMenu ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    #contextMenu li {
      padding: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #contextMenu li:hover {
      background: #222;
    }

    #close {
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>

  <header>
    <h1>Your Zurus06.NAT Simulations</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="signin.html">Login</a>
    </nav>
  </header>

  <main>
    <h2>Simulation Dashboard</h2>

    <div class="top-controls">
      <input type="text" id="simInput" placeholder="Enter simulation name..." />
      <button class="btn-create" id="createBtn">+ Create Simulation</button>
    </div>

    <div class="cards-container" id="cardsContainer"></div>

    <div class="renameSection">
      <h1>Rename Simulation?</h1>
      <input type="text" id="newSimName" placeholder="Enter a new name for simulation..." />
      <button id="rename">Rename Simulation</button>
      <button id="close">Close</button>
    </div>

    <div id="contextMenu">
      <ul>
        <li onclick="goTo('edit')" class="options">Edit Simulation</li>
        <li onclick="goTo('delete')" class="options">Delete Simulation</li>
        <li onclick="goTo('copy')" class="options">Copy Embed Code</li>
        <li onclick="goTo('rename')" class="options">Rename Simulation</li>
      </ul>
    </div>
  </main>

  <script type="module">
    import { URL } from "./config.js";
    const cardsContainer = document.getElementById("cardsContainer");
    const closeBtn = document.getElementById("close");
    const createBtn = document.getElementById("createBtn");
    const contextMenu = document.getElementById("contextMenu");
    const simInput = document.getElementById("simInput");
    const renameSection = document.querySelector(".renameSection");
    const renameBtn = document.querySelector("#rename");
    let selectedSimId;
    let selectedSimCard;
    let simulations = [];


    async function renderCards() {
      cardsContainer.innerHTML = "";
      closeBtn.addEventListener("click", async ()=>{
        renameSection.style.display = "none";
      })

      renameBtn.addEventListener("click", async ()=>{
        const newName = document.getElementById("newSimName").value.trim();
        if (newName.length < 10 || newName.length > 50){
          document.getElementById("newSimName").value = "";
          return alert("Simulation Name should be around 10-50 charachters");
        }
        if (!newName) return alert("Please enter a new name for the simulation.");

        const res = await fetch(`${URL}/diagrams/rename/${selectedSimId}`, {
          method: "PUT",
          body: JSON.stringify(newName),
          headers: { "Content-Type": "application/json" },
          credentials: "include"
        });

        const data = await res.json();
        alert(data.message);
        
        if (res.ok) {
          renameSection.style.display = "none";
          document.getElementById("newSimName").value = "";
          renderCards();
        }
      })

      try {
        const res = await fetch(URL+"/diagrams/all", {
          method: "GET",
          credentials: "include"
        });

        if (!res.ok) throw new Error("Failed to fetch simulations");

        const simulationsJson = await res.json();
        const simulations = simulationsJson.data;

        if (!simulations.length) {
          cardsContainer.innerHTML = "<p>No simulations yet.</p>";
          return;
        }

        simulations.forEach(sim => {
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.name = sim.name;
          card.id = sim.id;
          card.innerHTML = `
            <h3>Simulation Name: ${sim.name}</h3>
            <h4>Simulation UUID: ${sim.id}</h4>
            <p>Created: ${new Date(sim.createdAt).toDateString()}</p>
          `;
          card.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            selectedSimId = sim.id;
            selectedSimCard = card;
            contextMenu.style.top = `${event.pageY + 10}px`;
            contextMenu.style.left = `${event.pageX + 10}px`;
            contextMenu.style.display = "block";
          });
          cardsContainer.appendChild(card);
        });
      } catch (error) {
        alert("Your session just ended, Login to continue");
        window.location = "signin.html";
      }
    }

    document.addEventListener("click", () => {
      contextMenu.style.display = "none";
    });

    async function goTo(action) {
      if (!selectedSimId) return alert("No simulation selected");

      if (action === "edit") {
        window.location = `/browser/simulation.html?id=${selectedSimId}`;
      } 
      else if (action === "delete") {
        if (!confirm("Are you sure you want to delete this simulation?")) return;
        await fetch(`${URL}/diagrams/${selectedSimId}`, {
          method: "DELETE",
          credentials: "include"
        }).then(res => res.json())
        .then(data => {
          alert(data.message);
        })
        renderCards();
      }
      else if (action == "copy") {
        const embedCodeJson = await fetch(`${URL}/diagrams/embed-code/${selectedSimId}`, {
          method: "GET",
          credentials: "include"
        });
        const embedData = await embedCodeJson.json();
        const embedCode = embedData.data;
        navigator.clipboard.writeText(embedCode)
          .then(() => {
            alert("Embed code copied to clipboard!");
          })
          .catch(err => {
            alert("Failed to copy embed code: " + err);
          });
      }
      else {
        renameSection.style.display = "flex";
        renameSection.children[1].value= selectedSimCard.dataset.name;
      }
    }

    createBtn.addEventListener("click", async () => {
      const name = simInput.value.trim();
      if (name.length < 10 || name.length > 50){
        document.getElementById("simInput").value = "";
        return alert("Simulation name should be around 10-50 charachters");
      }
      if (!name) return alert("Please enter a simulation name.");

      console.log("Sending:", { diagramName: name }); // Debugging

      await fetch(URL+"/diagrams/new", {
        method: "POST",
        body: JSON.stringify({ diagramName: name }),
        headers: { "Content-Type": "application/json" },
        credentials: "include"
      }).then(res => res.json())
      .then(data => {
        alert(data.message);
      });

      simInput.value = "";
      renderCards();
    });

    renderCards();
  </script>
</body>
</html>